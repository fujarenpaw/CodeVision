# バタフライグラフ拡張機能 設計書

## 1. 概要

### 1.1 目的

この拡張機能は、Visual Studio Code上でソースコードの関数呼び出し関係をバタフライグラフとして視覚化し、コードベースの理解と探索を支援するためのものです。

### 1.2 背景

ソフトウェア開発において、コードの依存関係や呼び出しの流れを理解することは重要ですが、大規模なコードベースでは困難です。バタフライグラフは関数を中心に置き、その呼び出し元と呼び出し先を視覚的に表現することで、コードの把握を容易にします。

### 1.3 スコープ

この拡張機能はVS Codeのエコシステム内で動作し、C/C++、Pythonの3つのプログラミング言語に対応します。将来的には他の言語にも対応する可能性があります。

## 2. 機能要件

### 2.1 第一優先度（必須機能）

#### 2.1.1 基本機能

- VS Codeの拡張機能として実装
- 関数を選択して右クリックでバタフライグラフを表示
- LSPまたはCall Hierarchy APIを使用して関数の呼び出し関係情報を取得

#### 2.1.2 グラフ表示

- 中央に選択した関数を表示
- 左側に呼び出し元関数を表示
- 右側に呼び出し先関数を表示
- 各ノードに関数名を表示
- ノード間の関係を矢印で表示

#### 2.1.3 インタラクション

- 関数ノードをダブルクリックでソースコードを開き、実装箇所にジャンプ

#### 2.1.4 設定と制御

- 呼び出し元の階層数設定
- 呼び出し先の階層数設定
- 1階層あたりの表示関数数の上限設定

#### 2.1.5 対応言語

- C/C++
- Python

### 2.2 第二優先度（可能であれば実装）

#### 2.2.1 関数の概要情報表示

- 関数ノードにマウスオーバーした際に関数の概要情報をツールチップとして表示
- パラメータ、戻り値型、簡単な説明などを表示

#### 2.2.2 グラフの保存と共有

- バタフライグラフをSVGや画像として保存する機能
- コードベース理解の共有やドキュメンテーション用途に利用可能

#### 2.2.3 ズームとパン機能

- グラフの拡大・縮小機能
- グラフ内の自由な移動（パン）機能
- 複雑な大規模グラフでの閲覧性向上

#### 2.2.4 メモ・アノテーション機能

- 関数ノードにメモやアノテーションを追加できる機能
- チーム内でのコード理解共有やドキュメンテーションに活用

## 3. 技術仕様

### 3.1 アーキテクチャ

#### 3.1.1 主要コンポーネント

1. 拡張機能コア
   - VS Code拡張機能のエントリーポイント
   - コマンド登録と実行
   - 設定管理
2. コード解析エンジン
   - LSPまたはCall Hierarchy APIとの連携
   - 関数呼び出し情報の取得と処理
3. グラフ生成エンジン
   - 解析結果からバタフライグラフデータの生成
   - ビジュアライゼーションライブラリとの連携
4. 表示システム
   - WebViewによるグラフの表示
   - インタラクションの処理

#### 3.1.2 データフロー

1. ユーザーが関数を選択して右クリック→「バタフライグラフを表示」を選択
2. 選択された関数の情報をLSPまたはCall Hierarchy APIを使用して解析
3. 解析結果からグラフデータを生成
4. WebViewでグラフを表示
5. ユーザーの操作（ノードクリックなど）に応じた処理を実行

### 3.2 使用技術

#### 3.2.1 バックエンド

- TypeScript（VS Code拡張機能の実装言語）
- Call Hierarchy API
- VS Code Extension API

#### 3.2.2 フロントエンド

- HTML/CSS/JavaScript（WebView用）
- 以下のビジュアライゼーションライブラリのいずれか： 
  - Cytoscape.js
- WebViewとの通信にはメッセージパッシング

### 3.3 インターフェース設計

#### 3.3.1 ユーザーインターフェース

- コンテキストメニュー項目「バタフライグラフを表示」
- WebViewパネルでのグラフ表示
- グラフの操作UI（ズーム、パン、保存ボタンなど）
- 設定パネル

#### 3.3.2 設定項目

- `butterflyGraph.callerLevels`: 呼び出し元の階層数（デフォルト: 2）
- `butterflyGraph.calleeLevels`: 呼び出し先の階層数（デフォルト: 2）
- `butterflyGraph.maxNodesPerLevel`: 1階層あたりの最大ノード数（デフォルト: 10）
- `butterflyGraph.theme`: グラフの配色テーマ（デフォルト: "default"）

## 4. 実装計画

### 4.1 フェーズ1（基本機能）

- VS Code拡張機能の基本構造の実装
- LSP/Call Hierarchy APIとの連携実装
- 基本的なバタフライグラフ表示の実装（D3.js, Cytoscape.js, Vis.jsから1つ選定）
- C++言語のサポート実装

### 4.2 フェーズ2（機能拡張）

- Pythonのサポート追加
- グラフのインタラクション機能の強化
- 設定オプションの実装
- パフォーマンス最適化

### 4.3 フェーズ3（高度な機能）

- 第二優先度の機能の実装 
  - 関数概要情報表示
  - グラフの保存と共有
  - ズームとパン機能
  - メモ・アノテーション機能
- UI/UXの改善
- テストと品質向上

## 5. 懸念事項と対策

### 5.1 技術的な懸念

#### 5.1.1 パフォーマンスの問題

- **懸念**: 大規模なコードベースでの解析や表示に時間がかかる可能性

- 対策

  : 

  - インクリメンタルな解析の実装
  - 解析結果のキャッシュ
  - バックグラウンド処理の活用
  - レンダリングの最適化

#### 5.1.2 言語サーバーの制約

- **懸念**: 言語によって提供される情報の質や量に差がある

- 対策

  : 

  - 言語ごとの差異を考慮した設計
  - 共通インターフェースの定義
  - 情報が不足している場合の代替手段の提供

#### 5.1.3 WebViewの制限

- **懸念**: VS CodeのWebViewには制限があり、複雑なインタラクションが難しい

- 対策

  : 

  - WebViewの制限を考慮した設計
  - 効率的なメッセージングの実装
  - 必要に応じた機能の簡略化

### 5.2 機能面の懸念

#### 5.2.1 関数呼び出しの曖昧さ

- **懸念**: 動的言語やポリモーフィズムでは正確な呼び出し関係を把握できない場合がある

- 対策

  : 

  - 可能な限り正確な解析の提供
  - 曖昧な関係の明示
  - ユーザーへの適切なフィードバック

#### 5.2.2 拡張機能同士の競合

- **懸念**: 既存の言語拡張機能との競合の可能性

- 対策

  : 

  - 既存拡張機能との協調動作の検証
  - 競合時の対処方法の提供
  - 明確な依存関係の定義

## 6. テスト計画

### 6.1 ユニットテスト

- コンポーネントごとの単体テスト
- モックを使用したLSP/API呼び出しのテスト

### 6.2 統合テスト

- コンポーネント間の連携テスト
- エンドツーエンドのワークフローテスト

### 6.3 パフォーマンステスト

- 大規模コードベースでの動作検証
- メモリ使用量と応答時間の測定

## 7. 将来の拡張性

### 7.1 追加言語のサポート

- Java、JavaScript/TypeScript、Go、Rustなど他の言語への対応

### 7.2 高度な分析機能

- コードの複雑度メトリクス表示
- クラス階層やモジュール依存関係の可視化

## 8. 結論

この設計書に基づき、VS Code上でバタフライグラフを表示する拡張機能を段階的に開発していきます。第一優先度の機能を確実に実装し、その後第二優先度の機能を追加することで、ソフトウェア開発者にとって有用なコード理解支援ツールを提供します。